# Univariate distribution checks

This section reports a series of univariate summary checks of the CRASH-2 dataset.

```{r, message =FALSE, warning =FALSE , echo=FALSE}
library(tidyverse)
library(Hmisc)

# Define sets of predictors by type - helpful for selection
demog_vars <- c("age", "sex")
pyhiso_vars <- c("sbp", "hr", "rr", "gcs", "cc")
injury_vars <- c("injurytime", "injurytype")

## Load the dataset.
load("../Data/a_crash2.rda")
```

## Data set overview

Using the [Hmisc](https://cran.r-project.org/web/packages/Hmisc/) describe function, we provide an overview of the data set. The descriptive report also provides histograms of continuous variables. For ease of scanning the information, we group the report by measurement type. 

### Demographic variables

```{r desc_a_crash2a, message = FALSE, results='asis', warning=FALSE, , echo=FALSE}
a_crash2 %>%
  dplyr::select(all_of(demog_vars)) %>%
  Hmisc::describe(descript = "Demographic variables") %>%
  Hmisc::html(size = 80)
```


### Physiological measurements

```{r desc_a_crash2b, message = FALSE, results='asis', warning=FALSE, , echo=FALSE}
a_crash2 %>%
  dplyr::select(all_of(pyhiso_vars)) %>%
  Hmisc::describe(descript = "Physiological measurements") %>%
  Hmisc::html(size = 80)
```

### Characteristics of injury

```{r desc_a_crash2c, message = FALSE, results='asis', warning=FALSE, echo=FALSE}
a_crash2 %>%
  dplyr::select(all_of(injury_vars)) %>%
  Hmisc::describe(descript = "Characteristics of injury") %>%
  Hmisc::html(size = 80)
```

## Categorical variables

We now provide a closer visual examination of the categorical predictors. 

```{r catplot, message=FALSE, warning =FALSE , echo=FALSE}
a_crash2 %>%
  dplyr::select(sex, injurytype) %>%
  dplyr::mutate_all(forcats::as_factor) %>%   
  dplyr::mutate_all(forcats::fct_explicit_na, "NA") %>%
  tidyr::pivot_longer(
    dplyr::everything(),
    names_to = "var",
    values_to = "value",
    values_drop_na = FALSE
  ) %>%
  dplyr::group_by(var, value) %>%
  dplyr::summarize(N = n()) %>%
  dplyr::mutate(
    freq = N / sum(N),
    pct = round((freq * 100), 1),
    axis_lab = paste0(value, ' ', '(N = ', N, ')'),
    var_label = case_when(var == "sex" ~ "Sex",
                          var == "injurytype" ~ "Injury type")
  ) %>%
  ggplot(aes(
    x = reorder(axis_lab, pct),
    y = pct,
    label = pct
  )) +
  geom_text(nudge_y = 7) +
  geom_pointrange(aes(ymin = 0, ymax = pct), alpha = 1, size = 1, color = "grey") +
  geom_point(color = "firebrick2",
             alpha = 0.6,
             size = 3) +
  ylab("Percentage (%)") +
  scale_y_continuous(limits = c(0, 100)) +
  labs(caption = "Number of subjects with a non-missing value reported in brackets.\nNA = missing") +
  facet_wrap(~ var_label, ncol = 1, scales = "free_y") +
  coord_flip() +
  theme_minimal(base_size = 12) +
  theme(axis.title.y = element_blank(),
        panel.grid.minor = element_blank())

```

### Categorical ordinal plots

The Glasgow coma score, an ordinal categorical variable, is also displayed separately. 

```{r, message=FALSE, warning =FALSE , echo=FALSE}
a_crash2 %>%
  dplyr::select(gcs) %>%
  dplyr::mutate(gcs = as_factor(gcs)) %>%
  tidyr::pivot_longer(
    dplyr::everything(),
    names_to = "var",
    values_to = "value",
    values_drop_na = FALSE
  ) %>%
  dplyr::group_by(var, value) %>%
  dplyr::summarize(N = n()) %>%
  dplyr::mutate(
    freq = N / sum(N),
    pct = round((freq * 100), 1),
    value = as_factor(value),
    axis_lab = as_factor(paste0(value, ' ', '(N = ', N, ')'))
  ) %>%
  ggplot(aes(
    x = axis_lab,
    y = pct,
    label = pct
  )) +
  geom_text(nudge_y = 7) +
  geom_pointrange(aes(ymin = 0, ymax = pct), alpha = 1, size = 1, color = "grey") +
  geom_point(color = "firebrick2",
             alpha = 0.6,
             size = 3) +
  ylab("Percentage (%)") +
  scale_y_continuous(limits = c(0, 100)) +
  labs(title = "Glasgow coma score (point scale)",
    caption = "Number of subjects with a non-missing value reported in brackets.\nNA = missing") +
  coord_flip() +
  theme_minimal(base_size = 12) +
  theme(axis.title.y = element_blank(),
        panel.grid.minor = element_blank())
```



## Continuous variables 

A closer visual examination of continuous predictors. 

```{r, message =FALSE, warning =FALSE , echo=FALSE, fig.width=9}

a_crash2 %>%
  dplyr::select(age, sbp, rr, cc, hr, injurytime) %>%
  dplyr::mutate() %>%
  dplyr::mutate_all(as.numeric) %>%
  tidyr::pivot_longer(dplyr::everything(),
                      names_to = "var",
                      values_to = "value") %>%
  dplyr::mutate(
    var_label = case_when(
      var == "age" ~ "Age (years)",
      var == "sbp" ~ "Systolic blood pressure (mmHg)",
      var == "hr" ~  "Heart rate (1/min)",
      var ==  "rr" ~ "Respiratory rate (1/min)",
      var ==  "cc" ~ "Central capillary refill time (seconds)", 
      var == "injurytime" ~ "Injury time (days)"
    )) %>%
  ggplot(aes(value)) +
  ylab("Number of subjects") +
  geom_histogram(
    binwidth = 0.5,
    center = 0,
    alpha = 0.6,
    fill = "firebrick2"
  ) +
  facet_wrap(~ var_label, scales = "free", ncol = 2) +
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        panel.grid.minor = element_blank())

```


There is evidence of digit preference. Explore further with targeted summaries. A more detailed univariate summaries for the variables of interest are also provided below. 
### ida_plot function

```{r}
#' Function to generate a combined plot summary of univariate distributions
#' including 
#'  * jittered strip plot to show observed values
#'  * spike histogram with reference lines on 5 -number summary
#'  * boxplot 
#'  
#'
#' @param data input dataset
#' @param var variable to summarise
#' @param n_dodge if the 5 number summary clashes, split over n lines.
#'               Default is display over 1 line
#' @param bin_width Width of the histogram bin
#' @param sigma transformation parameter for pseudo_log (NA for no transformation)
#' @return gg ggplot object
#' @export
#'
#' @examples
ida_plot_univar <- function(data, var, n_dodge = 1, 
                            bin_width = diff(range(data[[var]],na.rm=T))/min(length(unique(data[[var]])),100), 
                            sigma = NA, n_bars=100)                             {
  
  ## evaluate if sigma is na
  
  trans<-FALSE
  if(!is.na(sigma)) trans<-TRUE
  

  
  ## number of missing observations
  nmiss <-
    data %>% dplyr::filter(is.na(.data[[var]])) %>% dplyr::tally()
  
  ## number of non missing observations
  bign <-
    data %>% dplyr::filter(!is.na(.data[[var]])) %>% dplyr::tally()
  
  # vector of variable for calculating five number summary
  x <- as.numeric(data[[var]])
  x <- x[!is.na(x)]
  x_orig<-x
  if(trans) x <- pseudo_log(x, sigma=sigma)
  
  
  # breaks for histogram
  ## compute n_bars+1 quantiles and divide the range into nbars 
  ## take a weighted average of the two sequences to compromise between small and wide bins
  
  if(length(unique(x))<n_bars*2) {
    brks <- unique(x) 
    }  else {
    brks1 <- seq(min(x), max(x), length.out=n_bars+1)
    brks2 <- quantile(x, seq(0,1,1/n_bars))
    brks <- (brks2 + 3*brks1)/4
  }
  
  
  # title for plot
  title <-
    paste0("Univariate summary of ", label(data[[var]]), " [", units(data[[var]]), "]")
  
  # labels for histogram
  y_axis <- "Density"
  x_axis <-
    paste0(label(data[[var]]), " [", units(data[[var]]), "]")
  
  # caption to summarise missing data
  caption <-
    paste0(
      "All observed values, the distribution and the, min, max and interquartile range are reported\n",
      "n = ",
      bign,
      " subjects displayed. ",
      nmiss,
      " subjects with missing values are not presented."
    )
  if(trans) caption<-paste0(caption, "Using pseudo-log scale.")
  
  ## strip plot
  p1 <-
    ggplot(data=NULL,aes(x = x, y = 0)) +
    geom_jitter(
      width = 0.1,
      height = 0.1,
      alpha = 0.2,
      color = "firebrick2"
    ) +
    geom_rug(sides = "b") +
    scale_x_continuous(limit = c(min(x), max(x)),
                       breaks = round(fivenum(x), 1)) +
    ggplot2::theme_minimal() +
    ylab(y_axis) +
    theme(
      panel.grid.major.y = element_blank(),
      panel.grid.minor = element_blank(),
      axis.title = element_blank(),
      axis.text = element_blank()
    )
  
  ## plot histogram
  p2 <-
    data %>%
    filter(!is.na(.data[[var]])) %>%
        ggplot2::ggplot(aes(x)) +
    geom_histogram(aes(x=x, y=..density..),
                   breaks=brks,
      center = 0,
      alpha = 0.6,
      fill = "firebrick2"
    ) +
    geom_rug() +
    scale_x_continuous(
      limit = c(min(x), max(x)),
      breaks = fivenum(x),
      labels = round(fivenum(x_orig),1),
      guide = guide_axis(n.dodge = n_dodge)
    ) +
    ylab(y_axis) +
    ggplot2::theme_minimal() +
    theme(
      panel.grid.major.x = element_line(colour = "grey", size = 0.5),
      panel.grid.minor = element_blank(),
      axis.title.x = element_blank()
    )
  
  ## boxplot
  p3 <-
    data %>%
    filter(!is.na(.data[[var]])) %>%
    ggplot(aes(x = x, y = 0)) +
    geom_boxplot(outlier.shape = NA, width = 0.1) +
    scale_x_continuous(limit = c(min(x), max(x)),
                       breaks = c(fivenum(x))) +
    xlab(x_axis) +
    ggplot2::theme_minimal() +
    theme(
      panel.grid.major.y = element_blank(),
      panel.grid.minor = element_blank(),
      axis.title.y = element_blank(),
      axis.text = element_blank()
    )
  
  # layout for combined plot
  # histogram has more area
  layout <- c(patchwork::area(1, 1, 1, 6),
              patchwork::area(2, 1, 5, 6),
              patchwork::area(6, 1, 6, 6))
  
  ## combine plots
  gg <- p1 / p2 / p3 +
    patchwork::plot_layout(design = layout) +
    patchwork::plot_annotation(title = title,
                               caption = caption)
  
  return(gg)
}
```


### Age

```{r, fig.width=8, fig.height=3.5, fig.cap= "Distribution of subject age [years]" , echo=FALSE}
## This is a function the plots a strip plot, histogram and boxplot, including five number summary. 
ida_plot_univar(a_crash2, "age")
```

Five patients under the age of 17, the inclusion criteria for the study, with one patient aged 1. 

### Blood pressure

```{r, fig.width=8, fig.height=3.5, fig.cap= "Distribution of SBP" , echo=FALSE}
ida_plot_univar(a_crash2, "sbp", bin_width = 0.7)
```


### Respiratory rate


```{r, fig.width=8, fig.height=3.5, fig.cap= "Distribution of respiratory rate" , echo=FALSE}
ida_plot_univar(a_crash2, "rr", n_dodge = 2)
```


### Heart rate


```{r, fig.width=8, fig.height=3.5, fig.cap= "Distribution of heart rate", echo=FALSE}
ida_plot_univar(a_crash2, "hr")
```


### Central capillary refill time


```{r, fig.width=8, fig.height=3.5, fig.cap= "Distribution of Central capillary refill time", echo=FALSE}
ida_plot_univar(a_crash2, "cc", bin_width = 0.5)
```


### Hours since injury


```{r, fig.width=8, fig.height=3.5, fig.cap= "Distribution of hours since injury", echo=FALSE}
ida_plot_univar(a_crash2, "injurytime", n_dodge = 3, bin_width = 0.25)
```



## Section session info

```{r, warning=FALSE, message=FALSE, echo=FALSE}
sessionInfo()
```


