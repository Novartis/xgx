---
title: "PK/PD, Exposure-Response - Count"
author: "Alison Margolskee"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

## Overview

This document contains exploratory plots for count PD data as well as the R code that generates these graphs. The plots presented here are based on simulated data ([see: PKPD Datasets](PKPD_Datasets.html)). Data specifications can be accessed on [Datasets](Datasets.html) and Rmarkdown template to generate this page can be found on [Rmarkdown-Template](Rmarkdown/Multiple_Ascending_Dose_PKPD_count.Rmd). You may also download the Multiple Ascending Dose PK/PD dataset for your reference ([download dataset](Data/Multiple_Ascending_Dose_Dataset2.csv)).

## Setup

```{r, echo = TRUE, warning=FALSE, message=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(xgxr)

#flag for labeling figures as draft
status = "DRAFT"

## ggplot settings
xgx_theme_set()

```


## Load Dataset

```{r, warning=FALSE, message=FALSE}
#load dataset
pkpd_data <- read.csv("../Data/Multiple_Ascending_Dose_Dataset2.csv")

#ensure dataset has all the necessary columns
  pkpd_data = pkpd_data %>%
    mutate(ID      = ID,     #ID   column
           TIME    = TIME,   #TIME column name 
           NOMTIME = NOMTIME, #NOMINAL TIME column name
           PROFDAY = case_when(
             NOMTIME < 5*24 ~ 1 + floor(NOMTIME / 24),
             NOMTIME >= 5*24 ~ 6
             ), #PROFILE DAY day associated with profile, e.g. day of dose administration
           PROFTIME = NOMTIME - (PROFDAY - 1)*24, #PROFILE TIME, time associated with profile, e.g. hours post dose
           EVID    = EVID   , #EVENT ID, >= 1 is dose, otherwise measurement
           LIDV    = LIDV,   #DEPENDENT VARIABLE column name
           CENS    = CENS,   #CENSORING column name
           CMT     = CMT,    #COMPARTMENT column
           DOSE    = DOSE,   #DOSE column here (numeric value)
           TRTACT  = TRTACT, #DOSE REGIMEN column here (character, with units), 
           LIDV_NORM = LIDV/DOSE, 
           LIDV_UNIT = EVENTU, 
           DAY_label = ifelse(PROFDAY > 0, paste("Day", PROFDAY), "Baseline")
    )

#create a factor for the treatment variable for plotting
pkpd_data = pkpd_data %>%
  arrange(DOSE) %>%
  mutate(TRTACT_low2high = factor(TRTACT, levels = unique(TRTACT)), 
         TRTACT_high2low = factor(TRTACT, levels = rev(unique(TRTACT)))) %>%
  select(-TRTACT)

#create pk dataset
pk_data <- pkpd_data %>%
  filter(CMT==2)

#create pd dataset
pd_data <- pkpd_data %>%
  filter(CMT == 4) %>%
  mutate(count_low2high = factor(LIDV, levels = sort(unique(LIDV))),
         count_high2low = factor(LIDV, levels = rev(sort(unique(LIDV)))))

#create pkpd dataset
pkpd_data = bind_rows(pk_data, pd_data)

#create wide pkpd dataset for plotting PK vs PD
pkpd_data_wide = pd_data %>%
  select(ID, NOMTIME, RESPONSE = LIDV) %>%
  right_join(pk_data) %>%
  rename(CONC = LIDV) %>%
  filter(!is.na(RESPONSE))

#perform NCA, for additional plots
NCA = pk_data %>%
  group_by(ID, DOSE) %>%
  filter(!is.na(LIDV)) %>%
  summarize(AUC_0_24 = caTools::trapz(TIME[NOMTIME > 0 & NOMTIME <= 24], LIDV[NOMTIME > 0 & NOMTIME <= 24]), 
            Cmax_0_24     = max(LIDV[NOMTIME>0 & NOMTIME<= 24]), 
            AUC_tau = caTools::trapz(TIME[NOMTIME > 120 & NOMTIME <= 144], LIDV[NOMTIME > 120 & NOMTIME <= 144]), 
            Cmax_tau     = max(LIDV[NOMTIME > 120 & NOMTIME <= 144]), 
            AUC_acc = AUC_tau / AUC_0_24, 
            Cmax_acc = Cmax_tau / Cmax_0_24, 
            SEX      = SEX[1], #this part just keeps the SEX and WEIGHTB covariates
            WEIGHTB  = WEIGHTB[1],
            TRTACT_high2low = TRTACT_high2low[1],
            TRTACT_low2high = TRTACT_low2high[1]) %>%
  gather(PARAM, VALUE, -c(ID, DOSE, SEX, WEIGHTB, TRTACT_low2high, TRTACT_high2low)) %>%
  ungroup() %>%
  mutate(VALUE_NORM = VALUE/DOSE, 
         PROFDAY = ifelse(PARAM %in% c("AUC_0_24", "Cmax_0_24"), 1, 6), 
         DAY_label = paste("Day", PROFDAY))

# Merge with PD data
NCA = pd_data %>%
  group_by(ID) %>%
  arrange(desc(TIME)) %>%
  slice(1) %>%
  select(ID, RESPONSE = LIDV) %>%
  right_join(NCA)

#units and labels
  time_units_dataset = "hours"
  time_units_plot    = "days"
  trtact_label       = "Dose"
  dose_units         = unique((pkpd_data %>% filter(CMT == 1) )$EVENTU) %>% as.character()
  dose_label         = paste0("Dose (", dose_units, ")")
  conc_units         = unique(pk_data$LIDV_UNIT) %>% as.character()
  conc_label         = paste0("Concentration (", conc_units, ")")
  concnorm_label     = paste0("Normalized Concentration (", conc_units, ")/", dose_units)
  AUC_units          = paste0("h.", conc_units)
  pd_label           = "Count"


#directories for saving individual graphs
dirs = list(
  parent_dir = "Parent_Directory", 
  rscript_dir  = "./", 
  rscript_name = "Example.R", 
  results_dir  = "./", 
  filename_prefix   = "", 
  filename     = "Example.png")
```


## Provide an overview of the data

Summarize the data in a way that is easy to visualize the general trend of PD over time and between doses. Using summary statistics can be helpful, e.g. Mean +/- SE, or median, 5th & 95th percentiles. Consider either coloring by dose or faceting by dose. Depending on the amount of data one graph may be better than the other.

### PK and PD marker over time, colored by Dose, median, 5th, 95th percentiles by nominal time

Does the effect appear to increase and decrease quickly on a short time scale, or does is occur over a longer time scale? Do the PK and PD profiles appear to be on the same time scale, or does the PD seem delayed compared to the PK? Is there clear separation between the profiles for different doses? Does the effect appear to increase with increasing dose? Do you detect a saturation of the effect?

```{r, cache = TRUE, fig.width = 10, fig.height = 4, warning = FALSE, message= FALSE}

gg <- ggplot(data = pk_data, 
             aes(x = NOMTIME, y=LIDV, color = TRTACT_high2low, fill = TRTACT_high2low))
gg <- gg + xgx_geom_pi(percent_level = 0.95, geom = c("errorbar", "point", "line"), alpha = 0.5)
gg <- gg + xgx_scale_y_log10()
gg <- gg + ylab(conc_label)
gg <- gg + xgx_scale_x_time_units(units_dataset = "h", units_plot = "d")
gg <- gg + guides(color = guide_legend(""), fill = guide_legend(""))
gg <- gg + xgx_annotate_status(status)
gg <- gg + xgx_annotate_filenames(dirs)

gg 
gg %+% (data = pd_data) + ylab(pd_label) + scale_y_continuous()

```


### PK and PD marker over time, faceted by Dose, median, 5th, 95th percentiles by nominal time

```{r, cache = TRUE, fig.width = 10, fig.height = 4, warning = FALSE, message= FALSE}
gg + facet_grid(.~TRTACT_low2high) + aes(color = NULL) + theme(legend.position = "none")

gg %+% (data = pd_data %>% subset(DOSE > 0)) + 
  ylab(pd_label) + scale_y_continuous() + 
  facet_grid(.~TRTACT_low2high) + 
  aes(color = NULL) + 
  theme(legend.position = "none")

```


## Explore Variability

### PK and PD marker over time, colored by Dose, dots & lines grouped by individuals

```{r, cache = TRUE, fig.width = 10, fig.height = 4, warning = FALSE, message= FALSE}

gg <- ggplot(data = pk_data, 
             aes(x = TIME, y = LIDV, color = TRTACT_high2low, group = ID))
gg <- gg + geom_point(alpha = 0.5)
gg <- gg + geom_line(alpha = 0.5)
gg <- gg + xgx_scale_y_log10()
gg <- gg + ylab(conc_label)
gg <- gg + guides(color = guide_legend(""), fill = guide_legend(""))
gg <- gg + xgx_scale_x_time_units(units_dataset = "h", units_plot = "d")
gg <- gg + xgx_annotate_status(status)
gg <- gg + xgx_annotate_filenames(dirs)

gg 
gg %+% (data = pd_data) + 
  ylab(pd_label) + scale_y_continuous()

```

### PK and PD marker over time, faceted by Dose, dots & lines grouped by individuals

```{r, cache = TRUE, fig.width = 10, fig.height = 4, warning = FALSE, message= FALSE}
gg + facet_grid(.~TRTACT_low2high) + aes(color = NULL) + theme(legend.position = "none")

gg %+% (data = pd_data %>% subset(DOSE > 0)) + 
  ylab(pd_label) + scale_y_continuous() + 
  facet_grid(.~TRTACT_low2high) + 
  aes(color = NULL) + 
  theme(legend.position = "none")

```

## Explore Exposure-Response Relationship


```{r, cache = TRUE, fig.width = 10, fig.height = 6, warning = FALSE, message= FALSE}

gg <- ggplot(data = pkpd_data_wide, aes(x = CONC,y = RESPONSE))
gg <- gg + geom_jitter(aes(color = TRTACT_high2low), width = 0, height = 0.1, alpha = 0.5)
gg <- gg + ylab(pd_label) + xlab(conc_label)
gg <- gg + guides(color = guide_legend("")) 
gg <- gg + geom_smooth(method = "glm", method.args = list(family=poisson), color = "black")
gg <- gg + xgx_annotate_status(status)
gg <- gg + xgx_annotate_filenames(dirs)

gg 

```


```{r, cache = TRUE, fig.width = 8, fig.height = 3, warning = FALSE, message= FALSE}

gg <- ggplot(data = pkpd_data_wide %>% subset(PROFDAY %in% c(1,3,5)), 
             aes(y = CONC, x = RESPONSE))
gg <- gg + geom_boxplot(aes(group = RESPONSE)) + coord_flip()
gg <- gg + geom_jitter(aes(color = TRTACT_high2low), width = 0.1, height = 0, alpha = 0.5) 
gg <- gg + guides(color = guide_legend(""), fill = guide_legend(""))
gg <- gg + xlab(pd_label) + ylab(conc_label)
gg <- gg + xgx_scale_y_log10() 
gg <- gg + facet_grid(~DAY_label)
gg <- gg + xgx_annotate_status(status)
gg <- gg + xgx_annotate_filenames(dirs)

gg 
```


### Explore covariate effects on Exposure-Response Relationship

Stratify exposure-response plots by covariates of interest to explore whether any key covariates impact response independent of exposure. For examples of plots and code startifying by covariate, see [Continuous PKPD Covariate Section](Multiple_Ascending_Dose_PKPD_continuous.html#explore_covariate_effects_on_exposure-response_relationship)

### Individual response vs exposure hysteresis plots

Using geom_path you can create hysteresis plots of response vs exposure. Including details like arrows or colors can be helpful to indicate the direction of time.

If most of the arrows point up and to the right or down and to the left, this indicates a positive relationship between exposure and response (i.e. increasing exposure -> increasing response). Arrows pointing down and to the right or up and to the left indicate a negative relationship.

In a hysteresis plot, you want to determine whether the path is curving, and if so in what direction. If you detect a curve in the hysteresis plot, this indicates there is a delay between the exposure and the response. Normally, a clockwise turn indicates that increasing exposure is associated with (a delayed) increasing response, while a counter clockwise turn indicates increasing concentration gives (a delayed) decreasing response.

In the plots below, most of the hysteresis paths follow a counter clockwise turn, with most arrows pointing up and to the right or down and to the left, indicating the effect increases in a delayed manner with increasing concentration.

```{r, cache = TRUE, fig.width = 8, fig.height = 15, warning = FALSE, message= FALSE}

data_to_plot2 <- pkpd_data_wide

gg <- ggplot(data = data_to_plot2, aes(x = CONC, y = RESPONSE, color = TIME))
gg <- gg + geom_path(arrow = arrow(length=unit(0.15,"cm")))
gg <- gg + xgx_scale_x_log10() + xgx_scale_y_log10()
gg <- gg + ylab(pd_label) + xlab(conc_label)
gg <- gg + facet_wrap(~ID + TRTACT_high2low, ncol = 5)
gg <- gg + xgx_annotate_status(status)
gg <- gg + xgx_annotate_filenames(dirs)

gg 
```


## R Session Info
```{r}
sessionInfo()
```