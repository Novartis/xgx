---
title: "PK/PD, Exposure-Response - Continuous - Receptor Occupancy"
author: "Andy Stein"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

## Overview
<!--START_EXPLANATION-->
This document contains exploratory plots for continuous PD data as well as the R code that generates these graphs. The plots presented here are based on simulated data ([see: PKPD Datasets](PKPD_Datasets.html)). Data specifications can be accessed on [Datasets](Datasets.html) and Rmarkdown template to generate this page can be found on [Rmarkdown-Template](Rmarkdown/Multiple_Ascending_Dose_PKPD_continuous.Rmd). You may also download the Multiple Ascending Dose PK/PD dataset for your reference ([download dataset](Data/RO_BCMA.csv)).

This data came from [1].  Here, the binding affinity (Kd) was reported to be 0.04 nM

Raje, Noopur S., et al. "Safety, clinical activity, pharmacokinetics, and pharmacodynamics from a phase I study of PF-06863135, a B-cell maturation antigen (BCMA)-CD3 bispecific antibody, in patients with relapsed/refractory multiple myeloma (RRMM)." (2019): 1869-1869.
<!--END_EXPLANATION-->
## Setup

```{r, error = TRUE, warning=FALSE, message=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(xgxr)

#flag for labeling figures as draft
status = "DRAFT"

## ggplot settings
xgx_theme_set()

#directories for saving individual graphs
dirs = list(
  parent_dir= tempdir(),
  rscript_dir  = "./",
  rscript_name = "Example.R",
  results_dir  = "./",
  filename_prefix   = "",
  filename     = "Example.png")
```

## Load Dataset

```{r, error = TRUE, warning=FALSE, message=FALSE}
#load dataset
pkpd_data <- read.csv("../Data/RO_BCMA.csv") %>%
  arrange(DOSE) %>%
  mutate(TRTACT = paste(DOSE, "ug/kg"),
         TRTACT_low2high = factor(TRTACT, levels = unique(TRTACT)), 
         TRTACT_high2low = factor(TRTACT, levels = rev(unique(TRTACT)))) %>%
  na.omit()

#units and labels
time_units_dataset = "days"
time_units_plot    = "days"
trtact_label       = "Dose"
dose_units         = "ug/kg"
dose_label         = paste0("Dose (", dose_units, ")")
conc_units         = "nM"
conc_label         = paste0("Concentration (", conc_units, ")")
concnorm_label     = paste0("Normalized Concentration (", conc_units, ")/", dose_units)

```


## Provide an overview of the data
<!--START_EXPLANATION-->
Here, we're only focusing on concentration vs free fraction data.  Observe the overall shape of the average profiles. It's expected to have an Emax-like shape
<!--END_EXPLANATION-->
```{r, error = TRUE, cache = TRUE, fig.width = 5, fig.height = 4, warning = FALSE, message= FALSE}

g = ggplot(data = pkpd_data, aes(x = CTOT, y = T_FREEFRAC))
g = g + geom_point(aes(color = TRTACT_high2low))
g = g + xgx_scale_x_log10()
g = g + xgx_scale_y_log10()
g = g + labs(x = conc_label, y = "Free Fraction", color = dose_label)
g = g + xgx_annotate_status(status)
g = g + xgx_annotate_filenames(dirs)
print(g)

gdata = g

```

## Try nlsLM 
```{r}
g = gdata
#g = g + xgx_geom_smooth_emax()
g = g + xgx_stat_smooth(method = "nlsLM",
                        formula = y ~ 1 - x/(exp(logED50) + x),
                        method.args = list(
                          start = list(logED50 = log(0.1)),
                          lower = c(-Inf)
                        ), se = TRUE)
g = g + xgx_scale_y_log10(limits = (c(0.01,2)))
print(g)

```

## try nlsLM with Alison code
```{r}
source("xgx_stat_smooth.R") #WILL NEED TO BE CORRECTED IN XGXR

binding_data = pkpd_data %>%
  rename(Ctot = CTOT, Tfreefrac = T_FREEFRAC) %>%
  mutate(Kd = 0.04)
 
Tfrac_formula = Tfreefrac ~ (-(Ctot - Ttot + Kd) + sqrt((Ctot - Ttot + Kd)^2 + 4 * Ttot * Kd))/ (2 * Ttot)
mod = minpack.lm::nlsLM(Tfrac_formula, data = binding_data, start = list(Ttot = 1))
broom::tidy(mod)
 
gg <- ggplot(data = binding_data %>% na.omit(), aes(x = Ctot, y = Tfreefrac)) +
  geom_point() +
  xgx_geom_smooth(method = "nls", 
                  method.args = list(formula = y ~ (-(x - Ttot + 0.04) + sqrt((x - Ttot + 0.04)^2 + 4 * Ttot * 0.04))/(2 * Ttot),
                    start = list(Ttot = 4) ), color = "black", size = 0.5, alpha = 0.25)
 
g = gdata
#g = g + xgx_geom_smooth_emax()
g = g + xgx_stat_smooth(method = "nlsLM",
                        formula = y ~ 1 - x/(exp(logED50) + x),
                        method.args = list(
                          start = list(logED50 = log(0.1)),
                          lower = c(-Inf)
                        ), se = TRUE)
g = g + xgx_scale_y_log10(limits = (c(0.01,2)))
print(g)
```


## R Session Info
```{r}
sessionInfo()
```

