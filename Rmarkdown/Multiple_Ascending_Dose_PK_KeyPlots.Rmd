---
title: "PK - Multiple Ascending Dose - Using Novartis dzz file"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

### Overview
This document contains PK exploratory graphs and also the R code that generates these graphs, starting from the `dzz` and `PPtmp` files that are stored here:

* [dzz blinded dataset of drug concentrations](Data/dzz_PKConc.csv)
* [PPtmp blinded dataset of NCA parameters](Data/PPtmp_NCA.csv)

Data specifications can be accessed on [Datasets](Datasets.html) and Rmarkdown template to generate this page can be found on [Rmarkdown-Template](Rmarkdown/Multiple_Ascending_Dose_PK_KeyPlots.Rmd).


### Setup
```{r, warning=FALSE, message=FALSE}

#add key packages
  library(ggplot2)
  library(tidyr)
  library(dplyr)
  library(lubridate)
  library(stringr)
  library(xgxr,lib.loc = "../Rlib")
  
  
#flag for labeling figures as draft
  status = "DRAFT"

# ggplot settings
  xgx_theme_set()
  
# directories for saving individual graphs
dirs = list(
  parent_dir= tempdir(),
  rscript_dir  = "./",
  rscript_name = "Example.R",
  results_dir  = "./",
  filename_prefix   = "",
  filename     = "Example.png")
```

#### Load in data from dzz (concentrations) and format for plotting

```{r load_dzz, cache = TRUE, echo = TRUE, warning=FALSE, message=FALSE}
LOQassay = 1
drug1 = "ABC123"
drug2 = "DEF456"
  
#load data located here:
data_in = read.csv("../Data/dzz_PKConc.csv",stringsAsFactors = FALSE)

#create columns with dosing regimen information, based on ARM
data = data %>%
  mutate(DOSSTR          = str_replace(ARM,"Phase Ib? ",""),
         DRG1STR         = str_replace(DOSSTR,paste0(drug1," "),""),
         DRG1STR         = str_extract(DRG1STR,"^\\d* *mg Q\\dW"),
         DRG1DOS0        = as.numeric(str_extract(DRG1STR,"\\d*")),
         DRG1REG          = str_extract(DRG1STR,"Q\\dW"),
         DRG2STR          = str_extract(DOSSTR,paste0(drug2," \\d* *mg Q\\dW")),
         DRG2STR          = str_replace(DRG2STR,paste0(drug2," "),""),
         DRG2DOS0         = as.numeric(str_extract(DRG2STR,"\\d*")),
         DRG2REG          = str_extract(DRG2STR,"Q\\dW"),
         Comed           = ifelse(is.na(DRG2DOS0),"monotherapy","combination"),
         DRG1.DRG2       = paste(DRG1DOS0,Comed))

#create columns with time and normalized PK
data = data %>%
  filter(PCDTC!="") %>%
  group_by(SUBJID) %>%
  mutate(CYCLE      = as.numeric(substr(VISIT,7,8)),
         NOMTIMEH   = (CYCLE-1)*28*24+TMTPT,
         DATE       = ymd_hms(PCDTC),
         DATE0      = ymd_hms(first(PCDTC)),
         TIMEH      = (DATE-DATE0)/3600,
         RESN       = as.numeric(RESN),
         CENS       = RESN<LOQassay,
         RESN       = ifelse(CENS,LOQassay,RESN),
         RESNorm    = RESN/DRG1DOS0) %>%
  ungroup() %>%
  filter(NOMTIMEH>0)

#create simplified column names for plotting
data = data %>%
  arrange(DRG1DOS0,desc(DRG1REG)) %>%
  mutate(ID = SUBJID,
         DOSElabel = factor(DRG1STR,levels=rev(unique(DRG1STR))), #for proper ordering
         DOSE0 = DRG1DOS0,
         DOSE0label = paste(DOSE0,"mg"),
         DOSE0label = factor(DOSE0label,levels=rev(unique(DOSE0label))),
         REG = DRG1REG,
         NOMTIME = NOMTIMEH,
         TIME = TIMEH,
         CONC=RESN,
         CONCnorm = RESNorm)
```

#### Load in data from PPtmp (NCA) and format for plotting
```{r load_nca_PPtmp, cache = TRUE, echo = TRUE, warning=FALSE, message=FALSE}

nca = read.csv("../Data/PPtmp_NCA.csv",stringsAsFactors = FALSE)

#create columns with dosing regimen information, based on ARM
nca = nca %>%
  mutate(DOSSTR          = str_replace(ARM,"Phase Ib? ",""),
         DRG1STR         = str_replace(DOSSTR,paste0(drug1," "),""),
         DRG1STR         = str_extract(DRG1STR,"^\\d* *mg Q\\dW"),
         DRG1DOS0        = as.numeric(str_extract(DRG1STR,"\\d*")),
         DRG1REG          = str_extract(DRG1STR,"Q\\dW"),
         DRG2STR          = str_extract(DOSSTR,paste0(drug2," \\d* *mg Q\\dW")),
         DRG2STR          = str_replace(DRG2STR,paste0(drug2," "),""),
         DRG2DOS0         = as.numeric(str_extract(DRG2STR,"\\d*")),
         DRG2REG          = str_extract(DRG2STR,"Q\\dW"),
         Comed           = ifelse(is.na(DRG2DOS0),"monotherapy","combination"),
         DRG1.DRG2       = paste(DRG1DOS0,Comed),
         PPORRESNnorm    = PPORRESN/DRG1DOS0)

#create simplified column names  
nca = nca %>%
  arrange(DRG1DOS0,desc(DRG1REG)) %>%
  mutate(ID = SUBJID,
         DOSElabel = factor(DRG1STR,levels=unique(DRG1STR)), #for proper ordering
         DOSE0 = DRG1DOS0,
         REG = DRG1REG)  
```

## Specify units
``` {r}
#units and labels
  time_units_dataset = "hours"
  time_units_plot    = "day"
  trtact_label       = "Dose"
  dose_label         = "Dose (mg)"
  conc_label         = "Concentration (ng/ml)"  
  concnorm_label     = "Normalized Concentration (ng/ml)/mg"
  conc_units         = "ng/ml"
  AUC_units          = "h.ng/ml"
```

## Provide an overview of the data

### Concentration over time, faceted by regimen, colored by dose

```{r , cache = TRUE, echo = TRUE, warning=FALSE, message=FALSE, fig.width = 8, fig.height = 4}
gg <- ggplot(data = d, aes(x = NOMTIME, y = CONC, color = DOSE0label, group=DOSE0label))
gg <- gg + xgx_geom_ci()
gg <- gg + facet_grid(~REG)
gg <- gg + xgx_stat_ci(conf_level = .95)
gg <- gg + xgx_scale_y_log10() 
gg <- gg + xgx_scale_x_time_units(units_dataset = time_units_dataset, 
                                  units_plot    = time_units_plot)
gg <- gg + labs(y=conc_label,color = trtact_label)
gg <- gg + xgx_annotate_status(status)
gg <- gg + xgx_annotate_filenames(dirs)
#if saving copy of figure, replace xgx_annotate lines with xgx_save() shown below:
#xgx_save(width,height,dirs,"filename_main",status)
print(gg)
```

### Concentration over time, faceted by regimen and cycle number, colored by dose

```{r , cache = TRUE, echo = TRUE, warning=FALSE, message=FALSE, fig.width = 8, fig.height = 6}
gg = gg %+% filter(d,CYCLE %in% c(1,3))
gg = gg + aes(x=TMTPT,y=CONC)
gg = gg + labs(x = "Day")
gg = gg + facet_grid(CYCLE~REG,labeller=label_both,switch="y")
print(gg)
```


## Assess the dose linearity of exposure

### Dose normalized concentration

```{r , cache = TRUE, echo = TRUE, warning=FALSE, message=FALSE, fig.width = 8, fig.height = 4}
gg <- ggplot(data = d, aes(x = NOMTIME, y = CONCnorm, color = DOSE0label, group=DOSE0label))
gg <- gg + xgx_stat_ci(conf_level = .95)
gg <- gg + facet_grid(~REG)
gg <- gg + xgx_scale_y_log10() 
gg <- gg + xgx_scale_x_time_units(units_dataset = time_units_dataset, 
                                  units_plot    = time_units_plot)
gg <- gg + labs(y=conc_label,color = trtact_label)
gg <- gg + xgx_annotate_status(status)
gg <- gg + xgx_annotate_filenames(dirs)
#if saving copy of figure, replace xgx_annotate lines with xgx_save() shown below:
#xgx_save(width,height,dirs,"filename_main",status)
print(gg)
```

### Noncompartmental Analysis

```{r NCA, cache = TRUE, echo = TRUE, warning=FALSE, message=FALSE, fig.width = 6, fig.height = 8}
nca.filter = nca %>% 
  filter(WNLPARM %in% c("AUCINF_obs","AUClast","AUCtau","Cmax"))
g = ggplot(nca.filter,aes(x=DOSE0,y=PPORRESNnorm,group=DOSE0))
g = g + geom_boxplot(outlier.shape=NA)
g = g + geom_smooth(aes(group=NULL),show.legend = FALSE,se=FALSE)
g = g + geom_jitter(width=0,alpha=.3)
g = g + facet_grid(WNLPARM~REG,scales="free_y",switch="y")
g = g + xgx_scale_y_log10()
g = g + xgx_scale_x_log10(breaks=unique(d$DOSE0))
g = g + labs(x="First Dose (mg)",
             y="Normalized value (ug/ml/mg or ug/ml*d/mg)")
gg <- gg + xgx_annotate_status(status)
gg <- gg + xgx_annotate_filenames(dirs)
#if saving copy of figure, replace xgx_annotate lines with xgx_save() shown below:
#xgx_save(width,height,dirs,"filename_main",status)
print(g)
```

## Explore variability

### Spaghetti, grouped by dose

```{r , cache = TRUE, echo = TRUE, warning=FALSE, message=FALSE, fig.width = 8, fig.height = 4}
gg = ggplot(data = d, aes(x=TIME, y=CONC, group=ID))
gg = gg + geom_line(mapping=aes(group=ID),alpha = 0.5) 
gg = gg + geom_point(alpha = 0.5)
gg <- gg + xgx_scale_x_time_units(units_dataset = time_units_dataset, 
                                  units_plot    = time_units_plot)
gg = gg + xgx_scale_y_log10() 
gg <- gg + labs(y=conc_label,color = trtact_label)
gg = gg + theme(legend.position="none")   
gg = gg + facet_grid(REG~DOSE0,switch="y")
gg <- gg + xgx_annotate_status(status)
gg <- gg + xgx_annotate_filenames(dirs)
#if saving copy of figure, replace xgx_annotate lines with xgx_save() shown below:
#xgx_save(width,height,dirs,"filename_main",status)
print(gg)
```

## Explore irregularities in profiles

### Individual profiles
```{r , cache = TRUE, echo = TRUE, warning=FALSE, message=FALSE, fig.width = 10, fig.height = 18}
gg = ggplot(data = d, aes(x=TIME, y=CONC, group=ID))
gg = gg + geom_line() 
gg = gg + geom_point()
gg = gg + facet_wrap(~DOSElabel+ID)
gg <- gg + xgx_scale_x_time_units(units_dataset = time_units_dataset, 
                                  units_plot    = time_units_plot)
gg = gg + xgx_scale_y_log10() 
gg <- gg + labs(y=conc_label,color = trtact_label)
gg = gg + theme(legend.position="none")   
gg = gg + facet_grid(REG~DOSE0,switch="y")
gg <- gg + xgx_annotate_status(status)
gg <- gg + xgx_annotate_filenames(dirs)
#if saving copy of figure, replace xgx_annotate lines with xgx_save() shown below:
#xgx_save(width,height,dirs,"filename_main",status)
print(gg)
```

### R Session Info
```{r}
sessionInfo()
```