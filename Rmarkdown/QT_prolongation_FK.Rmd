---
title: "QT Prolongation Exploratory Plots"
author: "Chase Brown, Alison Margolskee, Fariba Khanshan, Andy Stein"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---
## Overview
<!--START_EXPLANATION-->
This document contains exploratory plots for QT interval data as well as the R code that generates these graphs. The plots presented here are based on a [PKQT dataset](Data/QT_Prolongation_dataset.csv). Data specifications can be accessed on [Datasets](Datasets.html) and Rmarkdown template to generate this page can be found on [Rmarkdown-Template](Rmarkdown/QT_prolongation.Rmd). You may also download the QT dataset for your reference ([download dataset](Data/QT_Prolongation_dataset.csv)).
<!--END_EXPLANATION-->


## Setup

```{r setup-environment, message=FALSE, error=TRUE, warning=FALSE, warn.conflicts = FALSE}
# xgxr and xgx github raw script url location
xgxr_master_url = "https://raw.githubusercontent.com/Novartis/xgxr/master/"
xgx_master_url = "https://raw.githubusercontent.com/Novartis/xgx/master/"
xgx_chase_url = "https://raw.githubusercontent.com/Novartis/xgx/chase/"

# Standard packages and xgxr
library(tidyverse)
library(gridExtra)
library(xgxr)
library(minpack.lm)
# Add new functions that have not yet been pushed to DaVinci system
source(paste0(xgxr_master_url, "R/xgx_stat_ci.R"))
source(paste0(xgxr_master_url, "R/xgx_stat_smooth.R"))


# Set seed for random number generator (for plots with jitter)
set.seed(12345)

# Flag for labeling figures as draft
status = "DRAFT"

# ggplot settings
xgx_theme_set()
```

## Load Dataset

```{r, error = TRUE, echo = TRUE, warning = FALSE, message = FALSE}
# Load Dataset
qt_data <- read.csv(paste0(xgx_chase_url, "Data/QT_Prolongation_dataset.csv"))

# Steady state prof day
SS_PROFDAY = 3
QT_PROFDAYS <- c(1, 4, 7)
# Time between doses
#   Units should match units of TIME
#   e.g. 24 for QD
#        12 for BID
#        7*24 for Q1W (when units of TIME are h)
TAU = 24 

# Ensure dataset has all the necessary columns
qt_data <- qt_data %>%
  mutate(ID          = SUBJID,          # ID column
         PROFTIME    = TIME,            # TIME column name
         PROFDAY     = as.numeric(stringr::str_replace(string = 
                                          stringr::str_replace(string = VISDAY, "DAY ", ""),
                                          pattern = "EOT",
                                          replacement = "30")),
         TIME        = PROFTIME + (PROFDAY - 1) * 24,
         SS          = case_when((DOSE == 400) & (PROFDAY %in% c(14, 15)) ~ TRUE,
                                 (DOSE == 600) & (PROFDAY %in% c(17, 18)) ~ TRUE,
                                 TRUE ~ FALSE),
         LIDV        = calculated_CONC,
         DOSE        = DOSE,            # DOSE column here (numeric value)
         LIDV_NORM   = LIDV/DOSE,
         LIDV_UNIT   = CONC_UNIT,
         AGE         = AGE,
         SEX         = SEX,
         ETHNICITY   = ETHNICITY,
         WEIGHT      = WEIGHT,
         HEIGHT      = HEIGHT,
         BASE_QT     = Derived_Baseline_QTcF,
         POST_TRT_QT = Derived_Post_Baseline_QTcF,
         DELTA_QT    = Change_baseline_derived_QTcF
  )

# Make factors from continuous variables
qt_data$ID <- as.factor(qt_data$ID)
qt_data$SEX <- as.factor(plyr::mapvalues(qt_data$SEX,
                                         from = c(1,2),
                                         to = c("M", "F")))
qt_data$DOSE_FACTOR <- as.factor(qt_data$DOSE)

qt_data$SC <- qt_data$LIDV / median(qt_data$LIDV)
qt_data$AGE_GROUP = factor(cut(qt_data$AGE, 2), ordered = TRUE)

# Drop NaNs
qt_data <- drop_na(qt_data)

# Noncompartmental Analysis (NCA) for determining $C_max$ without modeling
NCA = qt_data %>%
  filter(PROFDAY %in% c(1, 2) | SS) %>%
  group_by(ID, DOSE, SS) %>%
  filter(!is.na(LIDV)) %>%
  arrange(TIME) %>%
  summarize(AUC_last = caTools::trapz(TIME, LIDV),
            Cmax     = max(LIDV),
            DELTA_QT_max = max(DELTA_QT),
            # this part just keeps the SEX and WEIGHTB covariates
            SEX      = SEX[1],
            WEIGHT  = WEIGHT[1]) %>%
  pivot_longer(names_to = "PARAM",
               values_to = "VALUE",
               cols = -c(ID, DOSE, SEX, WEIGHT, DELTA_QT_max, SS)) %>%
  ungroup() %>%
  mutate(VALUE_NORM = VALUE/DOSE)



# Units and labels
time_units_dataset = "hours"
time_units_plot    = "days"
trtact_label       = "Dose"
dose_units         = "mg"
dose_label         = paste0("Dose (", dose_units, ")")
conc_units         = unique(qt_data$LIDV_UNIT)[1]#"ng/mL"
conc_label         = paste0("Concentration (", conc_units, ")")
AUC_units          = paste0("h.", conc_units)
concnorm_label     = paste0("Normalized Concentration (", conc_units, ")/", dose_units)
qt_label           = latex2exp::TeX("$\\Delta QTc_F$ (ms)")
cmax_label         = latex2exp::TeX(paste0("C_{max}(", conc_units, ")"))
```

<!--START_EXPLANATION-->
## Introduction to drug-induced QT Prolongation

Drug-induced arrhythmias, such as Torsades de Pointes, are life-threatening 
adverse events and are therefore important when considering certain aspects of 
a drug's toxicity. These drug-induced arrhythmias can be studied with 
QT interval data from an ECG.

There are 3-4 primary components of an ECG signal:

  * P wave (atrial depolarization)
  * QRS complex (ventricular depolarization)
  * T wave (ventricular repolarization)
  * U wave (papillary muscle repolarization - signal is not always clearly visible)

![](https://ecgwaves.com/wp-content/uploads/2016/09/lqts1-610x488.jpg){ width=40% }

Changes to this QT interval after drug treatment, which we denote here as 
$\Delta QT$ (and the heart rate corrected version $\Delta QTc_F$
[read more here](https://www.sciencedirect.com/science/article/abs/pii/000291499290562D)), have a relationship with the drug concentration and 
several covariates that we will explore in this PK-QT xGx template.
<!--END_EXPLANATION-->

## Provide an overview of the data

<!--START_EXPLANATION-->
Summarize the $\Delta QTc_F$ data for each dose with a simple table showing 
the mean and confidence intervals information for the maximum $\Delta QTc_F$ 
for each indivdual.
<!--END_EXPLANATION-->

```{r, fig.height=3, fig.width=8}
# Summary Table
data_summary <- function(x, alpha = 0.05) {
  n = length(x)
  mean = mean(x)
  lower = mean - qt(1- alpha/2, (n - 1))*sd(x)/sqrt(n)
  upper = mean + qt(1- alpha/2, (n - 1))*sd(x)/sqrt(n)
  std_dev = sd(x)
  return(list(y = mean, ymin = lower, ymax = upper, 
           mean = mean, lower = lower, upper = upper, std_dev = std_dev))
}


DT::datatable(NCA %>%
  group_by(DOSE, SS) %>%
  summarize(mean = signif(data_summary(DELTA_QT_max)$mean, 3),
            lower = signif(data_summary(DELTA_QT_max)$lower, 3),
            upper = signif(data_summary(DELTA_QT_max)$upper, 3),
            std_dev = signif(data_summary(DELTA_QT_max)$std_dev, 3)),
  options = list(dom = 't'),
  colnames = c("Steady State" = "SS"))
```

### PK and QT marker over time, colored by Dose, mean (95% CI) percentiles by time

<!--START_EXPLANATION-->
Summarize the data in a way that is easy to visualize the general trend of QT
over time. Using summary statistics can be helpful, 
e.g. Mean +/- SE, or median, 5th & 95th percentiles. 
Consider either coloring by dose or faceting by dose. 
Depending on the amount of data one graph may be better than the other.
<!--END_EXPLANATION-->

<!--START_EXPLANATION-->
Observe the overall shape of the average profiles.
Does the effect appear to increase and decrease quickly on a short time scale, 
or does is occur over a longer time scale? Do the PK and QT profiles appear 
to be on the same time scale, or does the QT seem delayed compared to the PK? 
Is there clear separation between the profiles for different doses? 
Does the effect appear to increase with increasing dose? 
<!--END_EXPLANATION-->

```{r,  fig.height=3, fig.width=8, error=TRUE, warning=FALSE}
# PK Data
gg <- ggplot(data = qt_data %>% filter(PROFDAY %in% c(1,2) | SS),
             aes(x = PROFTIME,
                 y = LIDV,
                 color = DOSE_FACTOR,
                 fill = DOSE_FACTOR))
gg <- gg + xgx_stat_ci(conf_level = .95)
gg <- gg + xgx_annotate_status(status)
gg <- gg + xgx_scale_x_time_units(units_dataset = time_units_dataset, 
                                  units_plot    = time_units_plot)
gg <- gg + guides(color = guide_legend(dose_label),
                  fill = guide_legend(dose_label))
gg <- gg + labs(y = conc_label)
gg <- gg + facet_wrap(~SS, labeller = as_labeller(c("FALSE" = "Day 1",
                                                    "TRUE" = "Steady State")))
print(gg + xgx_scale_y_log10()) 

# QT Data
gg + aes(y = DELTA_QT) + labs(y = qt_label)

```


## Explore Exposure-Response Relationship

<!--START_EXPLANATION-->

### Concentration vs $QTc_F$

Do you see any relationship between $QTc_F$ and concentration? 
Does response increase (decrease) with increasing dose? 
Are you able to detect a plateau or emax (emin) on the effect? 

We have provided several different models here to view the relationship between 
$\Delta QTc_F$ and concentration.

In many cases, the data will span dosages large enough to observe a plateau 
in the $\Delta QTc_F$ with increasing concentration.
In order to to better capture this quality of the data, 
we use the Emax function ($y = E_0 + E_{max} \frac{x}{ED_{50} + x}$)
which is well-suited for this task via `xgx_geom_smooth_emax()`.
Note that the line adn confidence intervals now overlap with the `xgx_stat_ci()`
means and error bars.

We also have the mixed effects models: $\Delta QTc_{F, ij} = (\beta_0 + b_{0i}) + \beta_1 * SC_{ij} + \epsilon_{ij}$
and $\Delta QTc_{F, ij} = (\beta_0 + b_{0i}) + log(1 + \beta_1 * SC_{ij}) + \epsilon_{ij}$
to model the relationship between $\Delta QTc_F$ and concentration available for exploration.

<!--END_EXPLANATION-->

```{r,  fig.height=7, fig.width=10, error=TRUE, warning=FALSE, message=FALSE}

# Same plot with several models
qt_conc_plot <- function(model_num){

  # Same QT vs Concentration for each plot
  gg <- ggplot(data = qt_data,
               aes(x = LIDV,
                   y = DELTA_QT))
  gg <- gg + geom_point(alpha = 0.5)
  gg <- gg + xgx_stat_ci(conf_level = .95, bins = 5, geom = c("errorbar", "point"))
  gg <- gg + xgx_annotate_status(status)
  gg <- gg + guides(color = guide_legend(""),
                    fill = guide_legend(""),
                    shape = guide_legend(dose_label))
  gg <- gg + labs(x = conc_label,
                  y = qt_label)


  # Add a different model for each plot
  if(model_num == 1){
    gg <- gg + geom_smooth(method = "loess", formula = "y ~ x")
    
    title <- latex2exp::TeX("Simple LOESS Fit$_{}$")
    subtitle <- latex2exp::TeX("y ~ x$_{}^{}$")
  }
  else if(model_num == 2){
    gg <- gg + xgx_geom_smooth_emax()
    
    title <- latex2exp::TeX("E_{max}")
    subtitle <- latex2exp::TeX("$y = E_0 + (E_{max} * x)(ED_{50} + x)^{-1}$")
  }
  else if(model_num == 3){
    model <- lm(formula = DELTA_QT ~ 1 + LIDV + ID,
            data = qt_data)

    gg <- gg + geom_smooth(mapping = aes(y = data.frame(predict(model, interval = "confidence"))$fit),
                           se = FALSE)
    gg <- gg + geom_smooth(mapping = aes(y = data.frame(predict(model, interval = "confidence"))$lwr),
                           se = FALSE,
                           color = "gray")
    gg <- gg + geom_smooth(mapping = aes(y = data.frame(predict(model, interval = "confidence"))$upr),
                           se = FALSE,
                           color = "gray")
    

    title = "Mixed Effects"
    subtitle <- latex2exp::TeX("$\\Delta QTc_{F, ij} = (\\beta_0 + b_{0i}) + \\beta_1 * Conc_{ij} + \\epsilon_{ij}$")
  }
  else if(model_num == 4){
    model <- lm(formula = DELTA_QT ~ 1 + log(1 + LIDV) + ID,
                data = qt_data)

    gg <- gg + geom_smooth(mapping = aes(y = data.frame(predict(model, interval = "confidence"))$fit),
                           se = FALSE)
    gg <- gg + geom_smooth(mapping = aes(y = data.frame(predict(model, interval = "confidence"))$lwr),
                           se = FALSE,
                           color = "gray")
    gg <- gg + geom_smooth(mapping = aes(y = data.frame(predict(model, interval = "confidence"))$upr),
                           se = FALSE,
                           color = "gray")
    title <- "Mixed Effects (log)"
    subtitle <- latex2exp::TeX("$\\Delta QTc_{F, ij} = (\\beta_0 + b_{0i}) + log(1 + \\beta_1 * Conc_{ij}) + \\epsilon_{ij}$")
    
  }
  gg <- gg + ggtitle(label = title,
                     subtitle = subtitle)
  gg <- gg+ theme(legend.position="none")
  return(gg)
}


grid.arrange(qt_conc_plot(1),
             qt_conc_plot(2),
             qt_conc_plot(3),
             qt_conc_plot(4),
             ncol = 2)
```



### Mixed Effects model with $C_{max}$ and AUC

<!--START_EXPLANATION-->
In addition to observing teh relationship between $\Delta QTc_F$ and concentration 
for all data points, we can look at the relationship with summaries of the profile, 
such as $C_{max}$ and $AUC$. The plots below use the mixed effects models, 
$\Delta QTc_{F, ij} = (\beta_0 + b_{0i}) + log(1 + \beta_1 * C_{max,ij}) + \epsilon_{ij}$
or $\Delta QTc_{F, ij} = (\beta_0 + b_{0i}) + 1 + \beta_1 * AUC_{ij} + \epsilon_{ij}$ 
to fit the data.

<!--END_EXPLANATION-->

```{r,  fig.height=3, fig.width=8, error=TRUE, warning=FALSE}
model <- lm(formula = DELTA_QT_max ~ 1 + VALUE + ID,
            data = NCA)

gg <- ggplot(data = NCA,
             aes(x = VALUE,
                 y = DELTA_QT_max))

gg <- gg + geom_smooth(method = "lm", mapping = aes(y = predict(model)))
gg <- gg + geom_point()

gg <- gg + xgx_annotate_status(status)
gg <- gg + guides(color = guide_legend(""), fill = guide_legend(""))
gg <- gg + labs(x = latex2exp::TeX("AUC"), y = qt_label)
gg <- gg + facet_grid(SS ~ PARAM, scales = "free_x", labeller = as_labeller(
                                    c("FALSE" = "Day 1",
                                      "TRUE" = "Steady State",
                                      "Cmax" = "Cmax","AUC_last" = "AUC")))
gg <- gg + labs(x = "", y = qt_label)
print(gg)
```


### Which covariates are related to the $\Delta QTcF$?

#### Sex

<!--START_EXPLANATION-->
One interesting or important note for QT prolongation studies is the statistically significant difference in QT intervals between sexes.  Due to hormonal upregulation or downregulation of inward-rectifier potassium channels, the QT interval is divergent between the sexes.  Therefore, this is an important covariate to consider within these QT prolongation analysis, along with the patient age distribution.
<!--END_EXPLANATION-->

```{r,  fig.height=3, fig.width=8, error=TRUE, warning=FALSE}
gg <- ggplot(data = qt_data,
             aes(x = LIDV,
                 y = DELTA_QT,
                 color = SEX,
                 fill = SEX))
gg <- gg + xgx_geom_smooth_emax()
gg <- gg + geom_point(alpha = 0.5, aes(shape = WEIGHT>70)) 
gg <- gg + xgx_stat_ci(conf_level = .95, bins = 5, geom = c("errorbar", "point"))

gg <- gg + xgx_annotate_status(status)
gg <- gg + guides(color = guide_legend(""), fill = guide_legend(""))
gg <- gg + labs(x = conc_label, y = qt_label)
print(gg)
```

### Mixed Effects model with $C_{max}$ and AUC

<!--START_EXPLANATION-->
The $C_{max}$ and $AUC$ plots can also be colored by sex to show sex-specific relationships.
Again, here we use the mixed effects models below:

$\Delta QTc_{F, ij} = (\beta_0 + b_{0i}) + log(1 + \beta_1 * C_{max,ij}) + \epsilon_{ij}$
and $\Delta QTc_{F, ij} = (\beta_0 + b_{0i}) + 1 + \beta_1 * AUC_{ij} + \epsilon_{ij}$ 

<!--END_EXPLANATION-->

```{r,  fig.height=3, fig.width=8, error=TRUE, warning=FALSE}
model <- lm(formula = DELTA_QT_max ~ 1 + VALUE + ID,
            data = NCA)

gg <- ggplot(data = NCA,
             aes(x = VALUE,
                 y = DELTA_QT_max,
                 fill = SEX,
                 color = SEX))

gg <- gg + geom_smooth(method = "lm", mapping = aes(y = predict(model)))
gg <- gg + geom_point(aes(shape = factor(DOSE)))

gg <- gg + xgx_annotate_status(status)
gg <- gg + guides(color = guide_legend(""),
                  fill = guide_legend(""),
                  shape = guide_legend(dose_label))
gg <- gg + labs(x = latex2exp::TeX("AUC"), y = qt_label)

gg <- gg + facet_grid(SS ~ PARAM, scales = "free_x", labeller = as_labeller(
                                    c("FALSE" = "Day 1",
                                      "TRUE" = "Steady State",
                                      "Cmax" = "Cmax","AUC_last" = "AUC")))
gg <- gg + labs(x = "", y = qt_label)
print(gg)
```



### Hysteresis Plots

The hysteresis plots can indicate the delayed repsonse to exposure.  In this case,
it appears that the paths are counter-clockwise (individual 28 shows this more clearly), 
which indicates that there is a delay between an increasing concentration and a decreasing response.

A clockwise path would indicate a delay in an increasing concentration causing an increasing response.

```{r fig.height=20, fig.width=10}
gg <- ggplot(data = qt_data,
             aes(x = LIDV,
                 y = DELTA_QT,
                 color = TIME))
gg <- gg + geom_path(arrow = arrow(length = unit(0.15,"cm")))
gg <- gg + xgx_annotate_status(status) 
gg <- gg + xgx_scale_x_log10()

gg <- gg + theme(panel.grid.minor.x = ggplot2::element_line(color = rgb(0.9,0.9,0.9)),
                 panel.grid.minor.y = ggplot2::element_line(color = rgb(0.9,0.9,0.9)))

gg + facet_wrap(~ID, ncol = 5)
gg <- gg + labs(x = conc_label, y = qt_label)
```


## R Session Info
```{r}
sessionInfo()
```
