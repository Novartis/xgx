---
title: "PK/PD, Exposure-Response - Time to Event"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

Rmarkdown template to generate this page can be found on [Rmarkdown-Template](Rmarkdown/Multiple_Ascending_Dose_PKPD_time_to_event.Rmd).


```{r, echo = FALSE, warning=FALSE, message=FALSE}
# remove reference to home directory in libPaths
.libPaths(grep("home", .libPaths(), value=TRUE, invert=TRUE))

# add localLib to libPaths for locally installed packages
.libPaths(c("localLib", .libPaths()))

# will load from first filepath first, then look in .libPaths for more packages not in first path
# version matches package in first filepath, in the case of multiple instances of a package

# library(rmarkdown)
library(ggplot2)
library(dplyr)
library(survival)
library(survminer)
library(xgxr)
```

# Explore Exposure-Response Relationship

Time-to-event plots can be summarized by Kaplan-Meier plots and stratified by exposure quartile to give an overview of the dose-response

## Create a Dataset

```{r warning=FALSE}

#Use the lung dataset to create a fake exposure dataset
km_data <- lung %>%
  mutate(fake_exposure = ph.ecog + age/50) %>%
  filter(!is.na(fake_exposure)) %>%
  mutate(exposure_quartile= cut(fake_exposure,
                             breaks=quantile(fake_exposure,c(0,.25,.5,.75,1)),
                             include.lowest=TRUE,
                             labels=paste0("Q",c(4,3,2,1))))

#these columns are required for your dataset
km_data <- km_data %>%
  mutate(exposure = exposure_quartile, #exposure quantile,
         time   = time,   #time of the event (or censoring)
         event  = status) #status: there are a three options for this column (see ?Surv)
                          #        a) 0 = censored (alive), 1 = dead (event)
                          #        b) 1 = censored (alive), 2 = dead (event)
                          #        c) 0 = right censored, 1 = event at time, 
                          #           2 = left censored,  3 = interval censored.
```

## Plot Kaplan Meier with Confidence Intervals
```{r warning=FALSE, message=FALSE}
km_fit <- survfit(Surv(time) ~ exposure, data = km_data, conf.int = 0.95)
gg <- ggsurvplot(km_fit, km_data, conf.int = TRUE, ggtheme = xgx_theme())
gg <- gg + xgx_scale_x_time_units(units_dataset = "day", units_plot = "year")
print(gg)
```
  


## R Session Info
```{r}
sessionInfo()
```